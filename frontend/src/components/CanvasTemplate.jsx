// src/components/CanvasTemplate.jsx
import React, { useRef, useState, useEffect } from "react";
import { Stage, Layer, Line, Rect } from "react-konva";
import { useNavigate } from "react-router-dom";
import axios from "axios";
import { useUserContext } from "../contexts/UserContext.jsx";
import { generateSafePngFileName } from "../utils/generateFileName.js";
import { dataURLtoFile } from "../utils/dataURLtoFile";
import "./CanvasTemplate.css";

// ===== API BASE ÏÑ§Ï†ï =====
const resolveApiBase = () => {
  let raw = (import.meta?.env?.VITE_API_BASE ?? "").trim();
  if (!raw || raw === "undefined" || raw === "null" || raw === "") {
    raw = "http://172.20.6.160:5000"; // ‚úÖ Í∏∞Î≥∏Í∞í
  }
  if (!/^https?:\/\//i.test(raw)) raw = `http://${raw}`;
  try {
    const u = new URL(raw);
    return `${u.protocol}//${u.host}`;
  } catch {
    return "http://172.20.6.160:5000";
  }
};
const API_BASE = resolveApiBase();

export default function CanvasTemplate({
  drawingType,
  nextRoute,
  title,
  currentStep,
}) {
  const navigate = useNavigate();
  const stageRef = useRef(null);
  const headerRef = useRef(null);
  const toolbarRef = useRef(null);
  const wrapperRef = useRef(null);
  const footerRef = useRef(null);

  const [lines, setLines] = useState([]);
  const [isDrawing, setIsDrawing] = useState(false);
  const levels = [2, 4, 8];
  const [penSize, setPenSize] = useState(levels[1]);
  const [canvasWidth, setCanvasWidth] = useState(1123);
  const [eraseCount, setEraseCount] = useState(0);
  const [resetCount, setResetCount] = useState(0);

  const totalSteps = 4;
  const isHorizontal = drawingType === "house";
  const BASE_WIDTH = isHorizontal ? 1123 : 794;
  const BASE_HEIGHT = isHorizontal ? 794 : 1123;

  const { userData, setUserData } = useUserContext();
  const [startTime] = useState(Date.now());
  const [showCancelModal, setShowCancelModal] = useState(false);
  const [showSubmitModal, setShowSubmitModal] = useState(false);
  const [showGuide, setShowGuide] = useState(false);

  // Ìéú ÍµµÍ∏∞ Í∏∞Î°ù
  const [penUsageHistory, setPenUsageHistory] = useState({
    thin: 0,
    normal: 0,
    thick: 0,
  });
  const thicknessMap = { 2: "thin", 4: "normal", 8: "thick" };

  // ÍµµÍ∏∞ Ï°∞Ï†à
  const increasePen = () => {
    const idx = levels.indexOf(penSize);
    if (idx < levels.length - 1) setPenSize(levels[idx + 1]);
  };
  const decreasePen = () => {
    const idx = levels.indexOf(penSize);
    if (idx > 0) setPenSize(levels[idx - 1]);
  };

  // Í∞ÄÏù¥Îìú ÏµúÏ¥à ÌëúÏãú
  useEffect(() => {
    const seen = localStorage.getItem("seenToolbarGuideV2");
    if (!seen) {
      setShowGuide(true);
      localStorage.setItem("seenToolbarGuideV2", "true");
    }
  }, []);

  // Ï∫îÎ≤ÑÏä§ ÌÅ¨Í∏∞ ÏûêÎèôÏ°∞Ï†ï
  useEffect(() => {
    const aspect = BASE_WIDTH / BASE_HEIGHT;
    const measureAndSet = () => {
      const headerH = headerRef.current?.getBoundingClientRect().height || 0;
      const toolbarW = toolbarRef.current?.getBoundingClientRect().width || 0;
      const footerRect = footerRef.current?.getBoundingClientRect();
      const footerH = footerRect?.height || 0;
      const screenW = window.innerWidth;
      const screenH = window.innerHeight;
      const H_GUTTER = 24;
      const V_GUTTER = 24;
      const availW = Math.max(0, screenW - toolbarW - H_GUTTER * 2);
      const availH = Math.max(0, screenH - headerH - footerH - V_GUTTER * 2);
      const widthIfHeightLimited = availH * aspect;
      setCanvasWidth(Math.floor(Math.min(availW, widthIfHeightLimited)));
    };
    measureAndSet();
    const ro = new ResizeObserver(measureAndSet);
    ro.observe(document.body);
    return () => ro.disconnect();
  }, [BASE_WIDTH, BASE_HEIGHT]);

  // Î≤ÑÌäº Ïù¥Î≤§Ìä∏
  const handleCancelClick = () => setShowCancelModal(true);
  const handleCancelConfirm = () => navigate("/");
  const handleNextClick = () => setShowSubmitModal(true);

  // ÌïµÏã¨ Î°úÏßÅ
  const handleNext = async () => {
    if (!stageRef.current) return;

    const sid =
      userData?.session_id ||
      sessionStorage.getItem("session_id") ||
      sessionStorage.getItem("user_id");

    if (!sid) {
      alert("ÏÑ∏ÏÖòÏù¥ ÏóÜÏäµÎãàÎã§. Í≤ÄÏÇ¨ ÏãúÏûë(Î°úÍ∑∏Ïù∏/Ï†ïÎ≥¥ ÏûÖÎ†•)Î∂ÄÌÑ∞ Ìï¥Ï£ºÏÑ∏Ïöî.");
      navigate("/");
      return;
    }

    try {
      // 1Ô∏è‚É£ Í∑∏Î¶º Ï∫°Ï≤ò
      const dataURL = stageRef.current.toDataURL({ pixelRatio: 2 });
      const fileName = generateSafePngFileName(userData || {}, drawingType);
      const file = dataURLtoFile(dataURL, fileName);

      // 2Ô∏è‚É£ ÏóÖÎ°úÎìú Îç∞Ïù¥ÌÑ∞ Íµ¨ÏÑ±
      const formData = new FormData();
      formData.append("drawing", file);
      formData.append("type", drawingType);
      formData.append("session_id", sid);
      formData.append("eraseCount", String(eraseCount));
      formData.append("resetCount", String(resetCount));
      formData.append(
        "duration",
        String(Math.floor((Date.now() - startTime) / 1000))
      );
      formData.append("penUsage", JSON.stringify(penUsageHistory));

      console.log("üì§ ÏóÖÎ°úÎìú ÏãúÏûë:", drawingType);
      const uploadRes = await axios.post(
        `${API_BASE}/api/drawings/upload`,
        formData,
        { headers: { "Content-Type": "multipart/form-data" } }
      );
      const data = uploadRes.data || {};
      console.log("‚úÖ ÏóÖÎ°úÎìú ÏôÑÎ£å:", data);

      const imagePath = data.path || data.result?.path || data.file_path || "";
      const fileOnly = imagePath.split("/").pop();

      // 3Ô∏è‚É£ YOLO Î∂ÑÏÑù ÏöîÏ≤≠
      const analyze = async () =>
        axios.get(`${API_BASE}/api/analyze`, {
          params: { file: fileOnly, type: drawingType, session_id: sid },
          timeout: 15000,
        });

      try {
        console.log("üß† YOLO Î∂ÑÏÑù ÏöîÏ≤≠:", fileOnly);
        await analyze();
      } catch {
        console.warn("‚ö†Ô∏è YOLO Ï≤´ ÏãúÎèÑ Ïã§Ìå® ‚Üí Ïû¨ÏãúÎèÑ Ï§ë");
        await new Promise((r) => setTimeout(r, 300));
        await analyze();
      }

      // 4Ô∏è‚É£ ÏÇ¨Ïö©Ïûê Îç∞Ïù¥ÌÑ∞ Í∞±Ïã†
      setUserData((prev) => ({
        ...(prev || {}),
        session_id: sid,
        drawings: {
          ...(prev?.drawings || {}),
          [drawingType]: {
            image: imagePath,
            eraseCount,
            resetCount,
            duration: Math.floor((Date.now() - startTime) / 1000),
          },
        },
      }));

      // 5Ô∏è‚É£ Îã§Ïùå ÌéòÏù¥ÏßÄ Ïù¥Îèô
      if (nextRoute && nextRoute.includes("step2")) navigate("/result/rotate");
      else if (nextRoute) navigate(nextRoute);
      else navigate("/result/rotate");
    } catch (err) {
      console.error("‚ùå ÏóÖÎ°úÎìú ÎòêÎäî Î∂ÑÏÑù Ïã§Ìå®:", err);
      alert(
        "Í∑∏Î¶º ÏóÖÎ°úÎìú ÎòêÎäî Î∂ÑÏÑù Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§. Ïû†Ïãú ÌõÑ Îã§Ïãú ÏãúÎèÑÌï¥Ï£ºÏÑ∏Ïöî."
      );
    }
  };

  // Í∑∏Î¶¨Í∏∞ Ìï∏Îì§Îü¨
  const handleMouseDown = (e) => {
    setIsDrawing(true);
    const thickness = thicknessMap[penSize];
    setPenUsageHistory((p) => ({ ...p, [thickness]: p[thickness] + 1 }));
    const stage = e.target.getStage();
    const pointer = stage.getPointerPosition();
    const scale = stage.scaleX();
    const pos = { x: pointer.x / scale, y: pointer.y / scale };
    setLines((p) => [
      ...p,
      { points: [pos.x, pos.y], stroke: "#111", strokeWidth: penSize },
    ]);
  };

  const handleMouseMove = (e) => {
    if (!isDrawing) return;
    const stage = e.target.getStage();
    const pointer = stage.getPointerPosition();
    const scale = stage.scaleX();
    const pos = { x: pointer.x / scale, y: pointer.y / scale };
    setLines((p) => {
      const last = p[p.length - 1];
      const updated = { ...last, points: [...last.points, pos.x, pos.y] };
      return [...p.slice(0, -1), updated];
    });
  };

  const handleMouseUp = () => setIsDrawing(false);
  const handleUndo = () => setLines((p) => p.slice(0, -1));
  const handleClear = () => setLines([]);

  const scale = canvasWidth / BASE_WIDTH;

  return (
    <div className="page-center house-page">
      {/* Ìó§Îçî */}
      <div className="canvas-header-row" ref={headerRef}>
        <div className="rectangle-header">
          <h2 className="rectangle-title">{title}</h2>
        </div>
      </div>

      {/* Î∞îÎîî */}
      <div className="canvas-body" ref={wrapperRef}>
        <div className="toolbar" ref={toolbarRef}>
          <div className="pen-stepper">
            <button onClick={increasePen} title="ÍµµÍ∏∞ ÎäòÎ¶¨Í∏∞">
              <img
                src="/assets/+.png"
                alt="ÍµµÍ∏∞ ÎäòÎ¶¨Í∏∞"
                width={45}
                height={45}
              />
            </button>
            <div
              style={{
                width: 45,
                height: 45,
                display: "flex",
                alignItems: "center",
                justifyContent: "center",
                margin: "8px 0",
              }}
            >
              <div
                style={{
                  width: penSize * 1.5,
                  height: penSize * 1.5,
                  borderRadius: "50%",
                  background: "#111",
                }}
              />
            </div>
            <button onClick={decreasePen} title="ÍµµÍ∏∞ Ï§ÑÏù¥Í∏∞">
              <img
                src="/assets/-.png"
                alt="ÍµµÍ∏∞ Ï§ÑÏù¥Í∏∞"
                width={45}
                height={45}
              />
            </button>
          </div>

          <img
            className="icon-oneback"
            src="/images/oneback.png"
            alt="ÎêòÎèåÎ¶¨Í∏∞"
            onClick={handleUndo}
          />
          <img
            className="icon-trash"
            src="/images/trash.png"
            alt="Ï≤òÏùåÎ∂ÄÌÑ∞"
            onClick={handleClear}
          />
          <img
            className="icon-help"
            src="/images/question.png"
            alt="ÎèÑÏõÄÎßê"
            onClick={() => setShowGuide(true)}
          />
        </div>

        <div className="canvas-wrapper">
          <div className="progress-indicator static-overlay">
            {Array.from({ length: totalSteps }).map((_, i) => (
              <span
                key={i}
                className={`dot ${i < currentStep ? "active" : ""}`}
              />
            ))}
          </div>

          <Stage
            width={canvasWidth}
            height={(canvasWidth * BASE_HEIGHT) / BASE_WIDTH}
            scale={{ x: scale, y: scale }}
            className="drawing-canvas"
            ref={stageRef}
            onMouseDown={handleMouseDown}
            onMouseMove={handleMouseMove}
            onMouseUp={handleMouseUp}
            onTouchStart={handleMouseDown}
            onTouchMove={handleMouseMove}
            onTouchEnd={handleMouseUp}
          >
            <Layer>
              <Rect
                x={0}
                y={0}
                width={BASE_WIDTH}
                height={BASE_HEIGHT}
                fill="white"
              />
              {lines.map((line, i) => (
                <Line
                  key={i}
                  points={line.points}
                  stroke={line.stroke}
                  strokeWidth={line.strokeWidth}
                  tension={0.5}
                  lineCap="round"
                />
              ))}
            </Layer>
          </Stage>
        </div>
      </div>

      {/* Ìë∏ÌÑ∞ */}
      <div className="footer-buttons-row" ref={footerRef}>
        <button className="btn-base btn-nextred" onClick={handleCancelClick}>
          Í≤ÄÏÇ¨ Í∑∏ÎßåÎëêÍ∏∞
        </button>
        <button className="btn-base btn-nextblue" onClick={handleNextClick}>
          Îã§ÏùåÏúºÎ°ú
        </button>
      </div>

      {/* Ï†úÏ∂ú Î™®Îã¨ */}
      {showSubmitModal && (
        <div
          className="modal-overlay"
          onClick={() => setShowSubmitModal(false)}
        >
          <div className="modal-content" onClick={(e) => e.stopPropagation()}>
            <h3>Ï†úÏ∂úÌï†ÍπåÏöî?</h3>
            <p>Ï†úÏ∂ú ÌõÑÏóêÎäî Í∑∏Î¶ºÏùÑ ÏàòÏ†ïÌï† Ïàò ÏóÜÏñ¥Ïöî</p>
            <div className="modal-buttons">
              <button
                className="modal-button confirm"
                onClick={() => {
                  setShowSubmitModal(false);
                  handleNext();
                }}
              >
                ÌôïÏù∏
              </button>
              <button
                className="modal-button cancel"
                onClick={() => setShowSubmitModal(false)}
              >
                Ï∑®ÏÜå
              </button>
            </div>
          </div>
        </div>
      )}

      {/* Ï∑®ÏÜå Î™®Îã¨ */}
      {showCancelModal && (
        <div
          className="modal-overlay"
          onClick={() => setShowCancelModal(false)}
        >
          <div className="modal-content" onClick={(e) => e.stopPropagation()}>
            <h3>ÎÇòÏ§ëÏóê Îã§Ïãú Ìï†ÎûòÏöî</h3>
            <p>ÏßÄÍ∏à Î©àÏ∂îÎ©¥ Ï≤òÏùåÎ∂ÄÌÑ∞ Îã§Ïãú ÏãúÏûëÌï¥Ïöî</p>
            <div className="modal-buttons">
              <button
                className="modal-button confirm"
                onClick={handleCancelConfirm}
              >
                ÌôïÏù∏
              </button>
              <button
                className="modal-button cancel"
                onClick={() => setShowCancelModal(false)}
              >
                Ï∑®ÏÜå
              </button>
            </div>
          </div>
        </div>
      )}

      {/* ÎèÑÏõÄÎßê Î™®Îã¨ */}
      {showGuide && (
        <div className="modal-overlay" onClick={() => setShowGuide(false)}>
          <div className="modal-content" onClick={(e) => e.stopPropagation()}>
            <h3>‚ú® Í∑∏Î¶º ÎèÑÍµ¨ ÏÇ¨Ïö©Î≤ï</h3>
            <ul style={{ textAlign: "left", padding: "0 1rem" }}>
              <li>‚úèÔ∏è ÍµµÍ∏∞: ÏñáÍ≤å / Ï§ëÍ∞Ñ / ÍµµÍ≤å</li>
              <li>‚Ü©Ô∏è ÎêòÎèåÎ¶¨Í∏∞</li>
              <li>üóë Ï≤òÏùåÎ∂ÄÌÑ∞</li>
              <li>üëâ Îã§ Í∑∏Î†∏ÏúºÎ©¥ Îã§Ïùå Î≤ÑÌäº!</li>
              <li>üü• Í∑∏ÎßåÎëêÎ©¥ Ï≤òÏùåÎ∂ÄÌÑ∞ Îã§Ïãú ÏãúÏûë!</li>
            </ul>
            <button
              className="modal-button confirm"
              onClick={() => setShowGuide(false)}
            >
              ÏïåÍ≤†Ïñ¥Ïöî!
            </button>
          </div>
        </div>
      )}
    </div>
  );
}
